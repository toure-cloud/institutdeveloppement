{% extends 'acceuil/base.html' %}
{% load static %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">

<div ng-app="dashboardApp" ng-controller="DashboardController">
<div class="container-fluid mt-4">

    <!-- üî• En-t√™te -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard Administrateur</h2>
        <a href="{% url 'logout' %}" class="btn btn-outline-danger">D√©connexion</a>
    </div>

    <!-- üìä Cartes de statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Inscriptions</h5>
                    <p class="card-text fs-3">{{ total_inscriptions }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Inscriptions ce mois</h5>
                    <p class="card-text fs-3">{{ inscriptions_mois }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Formations Populaires</h5>
                    <ul class="mb-0">
                        <li ng-repeat="(formation, count) in formations_count">{{ formation }}: {{ count }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Mois Inscriptions</h5>
                    <canvas id="moisChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- üîç Filtres et recherche -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Rechercher..." ng-model="recherche">
        </div>
        <div class="col-md-3">
            <select class="form-select" ng-model="filtreFormation">
                <option value="">Toutes les formations</option>
                <option ng-repeat="(formation, count) in formations_count">{{ formation }}</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" ng-model="filtreMois">
                <option value="">Tous les mois</option>
                <option ng-repeat="(mois, count) in mois_counts">Mois {{ mois }}</option>
            </select>
        </div>
    </div>

    <!-- üìã Table dynamique avec pagination -->
    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Photo</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Formation</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% verbatim %}
                <tr ng-repeat="inscrit in filteredInscriptions = (inscriptions 
                     | filter:recherche 
                     | filter:filtreParFormation 
                     | filter:filtreParMois) | limitTo: pageSize : (currentPage-1)*pageSize">
                    <td>
                        <img ng-src="{{ inscrit.photo_identite }}" class="img-thumbnail" style="width:50px;height:50px;object-fit:cover;">
                    </td>
                    <td>{{ inscrit.nom }} {{ inscrit.prenom }}</td>
                    <td>{{ inscrit.email }}</td>
                    <td>{{ inscrit.telephone }}</td>
                    <td>{{ inscrit.formation }}</td>
                    <td>{{ inscrit.date_inscription | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-1" ng-click="voirDetails(inscrit)"
                                data-bs-toggle="modal" data-bs-target="#detailsModal">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm me-1" ng-click="modifierInscrit(inscrit)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" ng-click="supprimerInscrit(inscrit.id)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endverbatim %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item" ng-class="{disabled: currentPage==1}">
                <a class="page-link" href="" ng-click="prevPage()">Pr√©c√©dent</a>
            </li>
            <li class="page-item" ng-repeat="n in [].constructor(numPages()) track by $index"
                ng-class="{active: $index+1==currentPage}">
                <a class="page-link" href="" ng-click="goToPage($index+1)">{{$index+1}}</a>
            </li>
            <li class="page-item" ng-class="{disabled: currentPage==numPages()}">
                <a class="page-link" href="" ng-click="nextPage()">Suivant</a>
            </li>
        </ul>
    </nav>

    <!-- üî• Modal D√©tails -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">D√©tails de l'Inscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% verbatim %}
                    <div class="row">
                        <div class="col-md-3">
                            <img ng-src="{{ selectedInscrit.photo_identite }}" class="img-fluid rounded mb-3">
                        </div>
                        <div class="col-md-9">
                            <p><strong>Nom :</strong> {{ selectedInscrit.nom }} {{ selectedInscrit.prenom }}</p>
                            <p><strong>Email :</strong> {{ selectedInscrit.email }}</p>
                            <p><strong>T√©l√©phone :</strong> {{ selectedInscrit.telephone }}</p>
                            <p><strong>Formation :</strong> {{ selectedInscrit.formation }}</p>
                            <p><strong>CMU :</strong> {{ selectedInscrit.cmu }}</p>
                            <p><strong>CNI :</strong> {{ selectedInscrit.cni }}</p>
                            <p><strong>Date :</strong> {{ selectedInscrit.date_inscription | date:'dd/MM/yyyy' }}</p>
                        </div>
                    </div>
                    {% endverbatim %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    {% verbatim %}
                    <button type="button" class="btn btn-danger" ng-click="supprimerInscrit(selectedInscrit.id)">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                    {% endverbatim %}
                </div>
            </div>
        </div>
    </div>

</div>
</div>

<!-- AngularJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
var app = angular.module('dashboardApp', []);
app.controller('DashboardController', function($scope, $http) {
    $scope.inscriptions = JSON.parse('{{ inscriptions_json|safe }}');
    $scope.recherche = "";
    $scope.filtreFormation = "";
    $scope.filtreMois = "";
    $scope.pageSize = 5;
    $scope.currentPage = 1;
    $scope.total_inscriptions = {{ total_inscriptions }};
    $scope.inscriptions_mois = {{ inscriptions_mois }};
    $scope.formations_count = JSON.parse('{{ formations_count|safe }}');
    $scope.mois_counts = JSON.parse('{{ mois_counts|safe }}');

    // üîπ Filtres
    $scope.filtreParFormation = function(inscrit){
        if (!$scope.filtreFormation) return true;
        return inscrit.formation === $scope.filtreFormation;
    };
    $scope.filtreParMois = function(inscrit){
        if (!$scope.filtreMois) return true;
        return new Date(inscrit.date_inscription).getMonth()+1 == $scope.filtreMois;
    };

    // üîπ Pagination
    $scope.numPages = function(){
        return Math.ceil($scope.inscriptions.filter($scope.filtreParFormation).length / $scope.pageSize);
    };
    $scope.prevPage = function(){ if($scope.currentPage>1) $scope.currentPage--; };
    $scope.nextPage = function(){ if($scope.currentPage<$scope.numPages()) $scope.currentPage++; };
    $scope.goToPage = function(n){ $scope.currentPage = n; };

    // üîπ Modal d√©tails
    $scope.voirDetails = function(inscrit) { $scope.selectedInscrit = inscrit; };

    // üîπ Supprimer via AJAX
    $scope.supprimerInscrit = function(inscritId){
        if(confirm("Voulez-vous vraiment supprimer cet inscrit ?")){
            let csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
            $http({
                method:"POST",
                url:"{% url 'supprimer_inscrit' %}",
                headers: {"Content-Type":"application/json","X-CSRFToken":csrfToken},
                data:{id:inscritId}
            }).then(function(response){
                $scope.inscriptions = $scope.inscriptions.filter(i=>i.id!==inscritId);
                showAlert(response.data.message,'success');
            }).catch(function(err){ showAlert("Erreur lors de la suppression !",'danger'); });
        }
    };

    // üîπ Modifier placeholder
    $scope.modifierInscrit = function(inscrit){
        showAlert("Fonction Modifier √† impl√©menter pour "+inscrit.nom,'info');
    };

    // üîπ Alertes Bootstrap
    function showAlert(msg,type){
        let alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.prepend(alertDiv);
        setTimeout(()=>{alertDiv.remove();},5000);
    }

    // üîπ Chart.js
    var ctx = document.getElementById('moisChart').getContext('2d');
    var moisLabels = Object.keys($scope.mois_counts).map(m=>`Mois ${m}`);
    var moisData = Object.values($scope.mois_counts);
    new Chart(ctx,{
        type:'bar',
        data:{
            labels:moisLabels,
            datasets:[{
                label:'Inscriptions par mois',
                data:moisData,
                backgroundColor:'rgba(255, 99, 132, 0.7)'
            }]
        },
        options:{responsive:true, plugins:{legend:{display:false}}}
    });

});
</script>
{% endblock %}
